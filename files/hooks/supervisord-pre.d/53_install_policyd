#!/bin/bash
mkdir -p /tmp/policyd-cluebringer/cluebringer
wget http://download.policyd.org/v2.0.14/cluebringer-v2.0.14.tar.xz -O /tmp/policyd-cluebringer/cluebringer.tar.xz
unxz -c /tmp/policyd-cluebringer/cluebringer.tar.xz | tar xv --strip-components=1 -C /tmp/policyd-cluebringer/cluebringer
for d in /tmp/policyd-cluebringer/cluebringer/database ; do for i in $d/core.tsql $d/accesscontrol.tsql $d/quotas.tsql $d/amavis.tsql $d/checkhelo.tsql $d/checkspf.tsql $d/greylisting.tsql ; do $d/convert-tsql mysql55 $i done ; done > $d/policyd.mysql
mysql -u root -p$MYSQL_ROOT_PASSWORD < /tmp/policyd-cluebringer/cluebringer/database/policyd.mysql

# Install and file move.
if [ -e "/user/local/lib/cbpolicyd-2.1" ]; then 
    echo "PolicyD found. Doing nothing."
    exit 0
fi

mv $path/cluebringer.conf /etc/cluebringer.conf

#can we populate cluebringer.conf database credentials from enviromental variables?

mkdir /usr/local/lib/cbpolicyd-2.1
cp -r cbp /usr/local/lib/cbpolicyd-2.1/
cp -r awitpt/awitpt /usr/local/lib/cbpolicyd-2.1/

cp cbpadmin /usr/local/bin/
cp cbpolicyd /usr/local/sbin/

mkdir /var/log/cbpolicyd
mkdir /var/run/cbpolicyd

chown cbpolicyd.cbpolicyd /var/log/cbpolicyd /var/run/cbpolicyd
